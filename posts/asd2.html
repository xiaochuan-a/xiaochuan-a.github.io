<!-- build time:Fri Oct 25 2024 16:47:58 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CH"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="很遗憾对吧" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="很遗憾对吧" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="很遗憾对吧" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="读书"><link rel="canonical" href="http://example.com/posts/asd2.html"><title>不要停下前进的脚步 | Softcute Surname Sakura = 很遗憾对吧 = 黑暗散尽，月华满天</title><meta name="generator" content="Hexo 6.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">不要停下前进的脚步</h1><div class="meta"><span class="item" title="创建时间：2023-07-21 11:25:14"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-07-21T11:25:14+08:00">2023-07-21</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Softcute Surname Sakura</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="https://s1.locimg.com/2023/07/17/7b40660726562.jpg"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CH"><link itemprop="mainEntityOfPage" href="http://example.com/posts/asd2.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/hutao.png"><meta itemprop="name" content="皓曦之月"><meta itemprop="description" content="黑暗散尽，月华满天, 比希望更炙热，比黑暗更深邃的，是爱啊！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="很遗憾对吧"></span><div class="body md" itemprop="articleBody"><div class="note primary"><p>2024/03/19 11：11<br>昨天优化了一段的自己的代码，感觉涉及技术点还是挺多的，在这里记录一下</p></div><p>最近宣贯的一个需求是：如果客户提了一个订单，需要审批人进行一个审批，但是这个审批人在一天内（24 小时）没有审批，我们就需要给审批人发送短信提醒一下，这个需求改造总体涉及三个功能点：<br><span class="kbd red">1：创建定时任务，每天的早上九点执行，检查审批单是否已经超过一天未处理，如果是，记录该审批人需要发送短信提醒</span><br><span class="kbd red">2：检查当前时间是否为工作日，需要将当前审批人的信息或者单号记录下来，如果不是工作日就不提醒，直接 return</span><br><span class="kbd red">3：当前审批人下的有多个订单未审批，只需要发送一条短信就行</span><br>首先是我的第一版代码编写思路：<br>（1）：这里首要的判断条件是要先对工作日和非工作日做出一个判断，因为如果不是工作日剩下的代码就不用继续执行了（这里的判断是调用的第三方 API，因为咱们国家的放假太抽象.. 还有调休在里面）<br>（2）：然后要获取到所有的订单，在获取到创建订单的时间，订单审批状态（未审批是 N 审批是 Y）及每个订单下的审批人信息<br>（3）：转换创建时间的时间格式，获取当前时间，进行对比，超过 24 小时执行发送短信逻辑</p><p></p><figure class="highlight java"><figcaption><span>第一版代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isWorkDayOrNot(<span class="keyword">new</span> <span class="title class_">Date</span>())) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;当前时间为工作日，开始执行定时任务&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">BUSINESS_SERVICE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ABS-BUSINESS-ECLOUD&quot;</span>;</span><br><span class="line">                List&lt;String&gt; phoneList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  <span class="comment">//领导手机号集合</span></span><br><span class="line">                <span class="comment">//根据产品编码，是否审批，操作编码(1:新增 4 9免费资源延期 )，获取所有待审批的订单审批单列表</span></span><br><span class="line">                List&lt;AbsTaskItem&gt; absTaskItems = iAbsTaskItemDao.selectTaskItemAndSkuNumByActulStatus();</span><br><span class="line">                <span class="keyword">if</span> (CommonUtil.isNotNullList(absTaskItems)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (AbsTaskItem absTaskItem : absTaskItems) &#123;</span><br><span class="line">                        <span class="type">Date</span> <span class="variable">createTime</span> <span class="operator">=</span> absTaskItem.getCreateTime();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">orderCreateTimeStr</span> <span class="operator">=</span> DateUtil.formatDate2Str(createTime, DateUtil.YYYY_MM_DDHHMMSS);</span><br><span class="line">                        <span class="type">DateTimeFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(DateUtil.YYYY_MM_DDHHMMSS);</span><br><span class="line">                        <span class="type">LocalDateTime</span> <span class="variable">orderCreateDateTime</span> <span class="operator">=</span> LocalDateTime.parse(orderCreateTimeStr, formatter);</span><br><span class="line">                        <span class="comment">//获取时间</span></span><br><span class="line">                        <span class="type">ZonedDateTime</span> <span class="variable">orderCreateTime</span> <span class="operator">=</span> ZonedDateTime.of(orderCreateDateTime, ZoneId.systemDefault());</span><br><span class="line">                        <span class="type">ZonedDateTime</span> <span class="variable">currentTime</span> <span class="operator">=</span> ZonedDateTime.now(ZoneId.systemDefault());</span><br><span class="line">                        <span class="comment">//计算时间差</span></span><br><span class="line">                        <span class="type">Duration</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(orderCreateTime, currentTime);</span><br><span class="line">                        <span class="keyword">if</span> (duration.toMinutes() &gt; <span class="number">24</span> * <span class="number">60</span>) &#123;</span><br><span class="line">                            <span class="comment">//根据单号去在途表查询属性  1116013001 是否免费测试  0-否 1-是</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">prodOrdSkuNum</span> <span class="operator">=</span> absTaskItem.getProdOrdSkuNum();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">charValue</span> <span class="operator">=</span> iProdistProdordSkuDao.selectProdordSkuNumByProSkuNumAndCharNum(prodOrdSkuNum);</span><br><span class="line">                            <span class="keyword">if</span> (StringUtils.equals(<span class="string">&quot;1&quot;</span>,charValue) &amp;&amp; StringUtils.isNotBlank(charValue)) &#123;</span><br><span class="line">                                <span class="type">String</span> <span class="variable">absTaskId</span> <span class="operator">=</span> absTaskItem.getAbsTaskId();</span><br><span class="line">                                <span class="comment">//获取到ABS_TASK_ID去代办表查询审批人的手机号</span></span><br><span class="line">                                List&lt;String&gt; TaskIdList = taskUserDao.selectPhoneNumByTaskId(absTaskId);</span><br><span class="line">                                phoneList.addAll(TaskIdList);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//手机号去重  每个审批人只发送一次</span></span><br><span class="line">                    List&lt;String&gt; newphoneList = phoneList.stream().distinct().collect(Collectors.toList());</span><br><span class="line">                    log.info(<span class="string">&quot;当前需要发送的审批人集合为:&quot;</span>+JSONObject.toJSONString(newphoneList));</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p></p><div class="note danger"><p>敲重点，在昨天重新审视代码的时候发现这段代码有很大问题，因为我忽略了一个东西，就是测试联调和正式生产环境上数据的差异。<br>测试环境可能只能几千条数据，生产有几千万的数据<br>首先这段代码（问题一这段）是查询出来所有的未审批的订单信息，注意，返回的是所有的数据，我们生产上估计有几百万或者几千万的数据，后面还要去循环这个集合<br>每一次的循环的里面还有这种时间转换的对比.... 肯定是不可取的，所以这个里需要做一个优化，思路是这样的<br>我们可以在查询的时候直接加一个对比函数，这个想法我试验过，但是在 mybatis 里面太难实现了，我试了很多中方法，每次要部署一下（本地我的服务有问题跑不起来），无奈放弃<br>所有用了第二种方法，分批去查询数据库中的数据，每一批设定值为 5000 条，定义一个自增的然后需要定义一个自增的变量</p></div><p></p><figure class="highlight java"><figcaption><span>问题一</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;AbsTaskItem&gt; absTaskItems = iAbsTaskItemDao.selectTaskItemAndSkuNumByActulStatus();</span><br><span class="line"><span class="keyword">for</span> (AbsTaskItem absTaskItem : absTaskItems) &#123;</span><br><span class="line">    <span class="comment">//处理逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>调整后的代码整体逻辑是不变的，但是在查询的时候增加了两个值，每次要查询的多少条数据 tchSize 和一个条数定义也叫偏移量 offset<br>大致可以理解为，假设我们有 500 条数据，我设置了每次查询 100 条和偏移量自增，第一次查询的数据就是 0-100 的数据，第二次由于偏移量自增查询的就是是 100-200 的数据，以此类推<br>这样在查询的时候就可以控制好每次要查询的条数，所以这里写的是 while (true) 死循环，查不到数据直接 break 跳出，下面是优化后的代码<p></p><p></p><figure class="highlight java"><figcaption><span>优化后</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (isWorkDayOrNot(<span class="keyword">new</span> <span class="title class_">Date</span>())) &#123; <span class="comment">//先对时间做一个判断</span></span><br><span class="line">              log.info(<span class="string">&quot;当前时间为工作日，开始执行定时任务&quot;</span>);</span><br><span class="line">              <span class="comment">//每次需要查询的次数</span></span><br><span class="line">              <span class="keyword">final</span> <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line">              <span class="comment">//自增变量</span></span><br><span class="line">              <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                  List&lt;AbsTaskItem&gt; absTaskItems = iAbsTaskItemDao.selectTaskItemAndSkuNumByActulStatus(offset, batchSize);</span><br><span class="line">                  <span class="keyword">if</span> (absTaskItems.isEmpty()) &#123;</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">//判断逻辑单独抽成一个方法，每次查询出来的5000条数据去做具体的判断</span></span><br><span class="line">                  processTaskItems(absTaskItems);</span><br><span class="line">                  offset += batchSize;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              log.info(<span class="string">&quot;非工作日，不执行移动云审批人发送短信提醒！&quot;</span>);</span><br><span class="line">              XxlJobLogger.log(<span class="string">&quot;非工作日，不执行移动云审批人发送短信提醒！&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">          e.getMessage();</span><br><span class="line">          log.error(<span class="string">&quot; %%%%%%移动云短信通知领导审批人进行审批异常error：&quot;</span> + e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//分割线==============================================mybatis逻辑===========================================================</span></span><br><span class="line">      select T.ABS_TASK_ITEM_ID,T.ABS_TASK_ID,PRODORD_SKU_NUM,T.ACTUAL_STATUS,T.ACTUAL_TIME,T.CREATE_TIME,</span><br><span class="line">	   T.SLA,T.IS_TIME_OUT,T.TIME_OUT,T.ACTUAL_STAFF,T.OPERATION_SUB_TYPE,T.SKU_NUM,T.SKU_NAME,</span><br><span class="line">	   T.PRODORD_SKU_NAME,T.TASK_ID,T.TASK_NAME,T.`ACTION`</span><br><span class="line">from abs_task.abs_task_item T</span><br><span class="line">where T.SKU_NUM = <span class="string">&#x27;111601&#x27;</span></span><br><span class="line">and T.ACTUAL_STATUS = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">and T.OPERATION_SUB_TYPE <span class="title function_">in</span> <span class="params">(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;9&#x27;</span>)</span></span><br><span class="line">order by T.CREATE_TIME ASC</span><br><span class="line">LIMIT #&#123;limit&#125; OFFSET #&#123;offset&#125;</span><br></pre></td></tr></table></figure><br>解决完这个问题后，第二个问题就是既然每次查询的出来的数据是定量的，但是每次不还是一次一次调用判断的方法吗，后面就想到了用线程池来解决这个问题<br><span class="kbd red">1：int cores=Runtime.getRuntime ().availableProcessors ()</span><br><span class="kbd red">2：ExecutorService executor = Executors.newFixedThreadPool(cores * 2);</span><br>首先第一个点就是为 1 的这行代码，意思就是获取到当前服务的 cpu 核心数，第二点就是创建一个 FixedThreadPool 线程池，其线程大小是（cores * 2）当前核心数的 2 倍，这种写法的好处就是合理利用当前服务器 cpu 的资源信息（我理解的是这样的）当然你也可以直接这么写 Executors.newFixedThreadPool (10); 这种就是直接创建当前线程大小为 10，就不用 cores*2 了，看自己啦～～<br>献上代码！<br><figure class="highlight java"><figcaption><span>简单的线程池使用</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processTaskItems</span><span class="params">(List&lt;AbsTaskItem&gt; absTaskItems,ConcurrentHashMap&lt;String, Boolean&gt; phoneMap)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前时间为工作日，开始执行定时任务&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">BUSINESS_SERVICE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ABS-BUSINESS-ECLOUD&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">cores</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(cores * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (AbsTaskItem absTaskItem : absTaskItems) &#123;</span><br><span class="line">            executor.submit(() -&gt; &#123;</span><br><span class="line">                <span class="type">Date</span> <span class="variable">createTime</span> <span class="operator">=</span> absTaskItem.getCreateTime();</span><br><span class="line">                <span class="type">String</span> <span class="variable">orderCreateTimeStr</span> <span class="operator">=</span> DateUtil.formatDate2Str(createTime, DateUtil.YYYY_MM_DDHHMMSS);</span><br><span class="line">                <span class="type">DateTimeFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(DateUtil.YYYY_MM_DDHHMMSS);</span><br><span class="line">                <span class="type">LocalDateTime</span> <span class="variable">orderCreateDateTime</span> <span class="operator">=</span> LocalDateTime.parse(orderCreateTimeStr, formatter);</span><br><span class="line">                <span class="comment">//获取时间</span></span><br><span class="line">                <span class="type">ZonedDateTime</span> <span class="variable">orderCreateTime</span> <span class="operator">=</span> ZonedDateTime.of(orderCreateDateTime, ZoneId.systemDefault());</span><br><span class="line">                <span class="type">ZonedDateTime</span> <span class="variable">currentTime</span> <span class="operator">=</span> ZonedDateTime.now(ZoneId.systemDefault());</span><br><span class="line">                <span class="comment">//计算时间差</span></span><br><span class="line">                <span class="type">Duration</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(orderCreateTime, currentTime);</span><br><span class="line">                <span class="keyword">if</span> (duration.toMinutes() &gt; <span class="number">24</span> * <span class="number">60</span>) &#123;</span><br><span class="line">                  <span class="comment">//根据单号去在途表查询属性  1116013001 是否免费测试  0-否 1-是</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">prodOrdSkuNum</span> <span class="operator">=</span> absTaskItem.getProdOrdSkuNum();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">charValue</span> <span class="operator">=</span> iProdistProdordSkuDao.selectProdordSkuNumByProSkuNumAndCharNum(prodOrdSkuNum);</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.equals(<span class="string">&quot;1&quot;</span>,charValue) &amp;&amp; StringUtils.isNotBlank(charValue)) &#123;</span><br><span class="line">                        <span class="comment">//获取到ABS_TASK_ID去代办表查询审批人</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">absTaskId</span> <span class="operator">=</span> absTaskItem.getAbsTaskId();</span><br><span class="line">                        List&lt;String&gt; TaskIdList = taskUserDao.selectPhoneNumByTaskId(absTaskId);</span><br><span class="line">                        <span class="keyword">if</span> (CommonUtil.isNotNullList(TaskIdList)) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (String phoneNum : TaskIdList) &#123;</span><br><span class="line">                                phoneMap.put(phoneNum, Boolean.TRUE);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executor.shutdown(); <span class="comment">//关闭启动线程</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 等待直到所有任务完成</span></span><br><span class="line">            executor.awaitTermination(Long.MAX_VALUE, TimeUnit.NANOSECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>最后一个知识点就是第三功能点，<span class="kbd red">3：当前审批人下的有多个订单未审批，只需要发送一条短信就行</span>这里在没有加线程处理数据之前，直接用的是 Arraylist 来存放数据的，加了之后就意识到线程安全的问题，后面就换成线程安全的<span class="kbd red"> ConcurrentHashMap&lt;String, Boolean&gt; phoneMap = new ConcurrentHashMap&lt;&gt;();</span>，使用完记得释放资源，不过后面还遇到了一个问题，作用域的问题<br>反正，额，这个好解决，根据自己的代码在调用 processTaskItems 方法前初始化就好了，然后执行完一定要 phoneMap.clear () 一下，不然小心内存溢出～～下课！！<p></p><div class="note warning no-icon"><p>我<sub>只</sub>是<sub>一</sub>个<sub>分</sub>割<sub>线</sub>我<sub>只</sub>是<sub>一</sub>个<sub>分</sub>割<sub>线</sub>我<sub>只</sub>是<sub>一</sub>个<sub>分</sub>割<sub>线</sub></p></div><div class="note success no-icon"><p>stream 流的常见使用方法 (搞笑简洁), 别嘲笑我，反正我是容易忘.....</p></div><p></p><figure class="highlight java"><figcaption><span>stream流的常见使用方法 参考链接 mark:1,6-7</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将数据通过stream流转换成key value的形式，使用的场景很多，取值得话直接根据产品编码Key获取就行</span></span><br><span class="line">HashMap&lt;String, String&gt; prodistCollect = prodistCharacters.stream()</span><br><span class="line">                        .collect(HashMap::<span class="keyword">new</span>, (x, item)-&gt; x.put(item.getCharNum(),item.getCharValue()),HashMap::putAll);</span><br><span class="line"><span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> prodistCollect.get(BusinessConstants.Character.PRODUCT_NUMBER_92023660001);</span><br><span class="line">逻辑判断...</span><br><span class="line">逻辑判断...</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果是产品的属性是有特殊的规则，比如成对出现的这种（0和1）我们就可以用stream流中的groupingBy方法来进行一个分组</span></span><br><span class="line">Map&lt;String, List&lt;ProdordCharacter&gt;&gt; listMap = prodordCharacters.stream().collect(Collectors.</span><br><span class="line">(ProdordCharacter::getAction));</span><br><span class="line"><span class="comment">//根据Action0和1进行分组</span></span><br><span class="line">List&lt;ProdordCharacter&gt; prodordCharacters0 = listMap.get(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">List&lt;ProdordCharacter&gt; prodordCharacters1 = listMap.get(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="comment">//获取所有的Action0和1属性组</span></span><br><span class="line">HashMap&lt;String, String&gt; map0 = prodordCharacters0.stream().collect(HashMap&lt;String, String&gt;::<span class="keyword">new</span>, (x, item) -&gt; x.put(item.getCharNum(), item.getCharValue()), HashMap::putAll);</span><br><span class="line">HashMap&lt;String, String&gt; map1 = prodordCharacters1.stream().collect(HashMap&lt;String, String&gt;::<span class="keyword">new</span>, (x, item) -&gt; x.put(item.getCharNum(), item.getCharValue()), HashMap::putAll);</span><br><span class="line">（通过map0和map1获取值来进行逻辑判断.....）</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过stream流里面的filter进行过滤，获取到指定产品编码的值，下面就是通过filter获取到30037属性的值，如果没有值则复制为空字符串</span></span><br><span class="line"><span class="comment">//对这个方法的返回值进行操作的时候要记得用StringUtils.isNotBlank()或者别的判空来做一个非空判断，不然可能会报转换异常</span></span><br><span class="line"><span class="type">String</span> <span class="variable">icbVal</span> <span class="operator">=</span> prodordTemplates.getProdordIcbs().stream()</span><br><span class="line">                        .filter(prodordIcbs -&gt; BusinessConstants.Icb.ICB_30037.equals(prodordIcbs.getParameterNum()))</span><br><span class="line">                        .map(ProdordIcbs::getParameterValue)</span><br><span class="line">                        .findFirst()</span><br><span class="line">                        .orElse(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//还有一种方法获取到指定产品编码的值，跟上面这种一样的方法进行过滤，但是最终返回值的类型不一样 </span></span><br><span class="line">Optional&lt;ProdordCharacters&gt; siteNumOptional = prodordCharactersList.stream().filter(x -&gt; BusinessConstants.Character.ICB_30037.equals(x.getCharNum())).findFirst();</span><br><span class="line"><span class="keyword">if</span> (siteNumOptional.isPresent()) &#123;</span><br><span class="line">    <span class="type">ProdordCharacters</span> <span class="variable">siteNumCharacters</span> <span class="operator">=</span> siteNumOptional.get();</span><br><span class="line">    <span class="type">String</span> <span class="variable">charValue</span> <span class="operator">=</span> siteNumCharacters.getCharValue();</span><br><span class="line">    逻辑判断...</span><br><span class="line">    逻辑判断...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取到这个属性具体字段的值，不然我这个返回的就是一个list</span></span><br><span class="line"><span class="type">String</span> <span class="variable">templateNum</span> <span class="operator">=</span> queryProdistSkuInfoRsp.getProdistTemplates()</span><br><span class="line">        .stream()</span><br><span class="line">        .map(ProdistTemplateDto::getTemplateNum)</span><br><span class="line">        .collect(Collectors.joining(<span class="string">&quot;&quot;</span>));</span><br><span class="line"><span class="comment">//将list集合转换成对象（如果明确只有一组数据的话 不然会出问题）</span></span><br><span class="line">List&lt;ProdordTemplates&gt; prodordTemplate = prodordSkus.getProdordTemplate();</span><br><span class="line"><span class="type">ProdordTemplates</span> <span class="variable">prodordTemplates1</span> <span class="operator">=</span> prodordTemplate.stream().findFirst().orElse(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//判断这个对象是否为空</span></span><br><span class="line">Optional&lt;ProdordTemplates&gt; optionalTemplates = Optional.ofNullable(prodordTemplates1);</span><br><span class="line"><span class="keyword">if</span> (optionalTemplates.isPresent()) &#123;</span><br><span class="line">    <span class="comment">// 对象不为空的处理逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(templateNum)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">rateTmplByTemplateNum</span> <span class="operator">=</span> callProductServiceClient.getRateTmplByTemplateNum(templateNum);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">rateresult</span> <span class="operator">=</span> JSONObject.parseObject(rateTmplByTemplateNum);</span><br><span class="line">        <span class="type">String</span> <span class="variable">ratebizCode</span> <span class="operator">=</span> rateresult.getString(<span class="string">&quot;bizCode&quot;</span>);</span><br><span class="line">        <span class="type">PcRateTmpl</span> <span class="variable">pcRateTmpl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;00000&quot;</span>.equals(ratebizCode)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">datarate</span> <span class="operator">=</span> rateresult.getString(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (com.bboss.common.util.StringUtils.isNotBlank(datarate)) &#123;</span><br><span class="line">                pcRateTmpl = JSONObject.parseObject(datarate, PcRateTmpl.class);</span><br><span class="line">                <span class="comment">//直接get返回的就是一个对象</span></span><br><span class="line">                <span class="type">ProdordTemplates</span> <span class="variable">prodordTemplates</span> <span class="operator">=</span> optionalTemplates.get();</span><br><span class="line">                <span class="keyword">if</span> ((pcRateTmpl.getNote().equals(<span class="string">&quot;M&quot;</span>) &amp;&amp; prodordTemplates.getNote().equals(<span class="string">&quot;F&quot;</span>)) </span><br><span class="line">                || (pcRateTmpl.getNote().equals(<span class="string">&quot;F&quot;</span>) &amp;&amp; prodordTemplates.getNote().equals(<span class="string">&quot;M&quot;</span>))) &#123;</span><br><span class="line">                    errMsg = String.format(<span class="string">&quot;当前套餐：[%s]，不支持包年包月互转!&quot;</span>,templateNum);</span><br><span class="line">                    log.error(errMsg);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(errMsg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><div class="note info"><p>简单的试一下这个代码块功能，下面代码其实很 low，看个乐呵就好，不必研究╰(<em>°▽°</em>)╯（不知道我在自言自语什么）</p></div><p></p><figure class="highlight java"><figcaption><span>解析JSON取值</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//下面只是一个示例</span></span><br><span class="line"><span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;check\&quot;:\&quot;[&#x27;1=&gt;-1&#x27;,&#x27;2=&gt;0|1|2|3|4|5&#x27;]\&quot;,\&quot;target\&quot;:\&quot;sjfl\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span>JSONObject.parseObject(a);</span><br><span class="line"><span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> jsonObject.get(<span class="string">&quot;target&quot;</span>).toString();</span><br><span class="line"><span class="type">String</span> <span class="variable">target1</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;target&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">check</span> <span class="operator">=</span> jsonObject.get(<span class="string">&quot;check&quot;</span>).toString();</span><br><span class="line">ArrayList&lt;String&gt; arrayList = JSON.parseObject(check, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;ArrayList&lt;String&gt;&gt;() &#123;&#125;);</span><br><span class="line"><span class="keyword">for</span> (String s : arrayList) &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;数组得值&quot;</span>+s);</span><br></pre></td></tr></table></figure><p></p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6/" rel="tag"><i class="ic i-tag"></i> 读书</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-09-27 15:52:24" itemprop="dateModified" datetime="2024-09-27T15:52:24+08:00">2024-09-27</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>皓曦之月 <i class="ic i-at"><em>@</em></i>很遗憾对吧</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/posts/asd2.html" title="不要停下前进的脚步">http://example.com/posts/asd2.html</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/asd1.html" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s1.locimg.com&#x2F;2023&#x2F;07&#x2F;19&#x2F;398a1ecb3a33d.jpg" title="测试记录案例"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>测试记录案例</h3></a></div><div class="item right"><a href="/posts/photo1.html" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;hexo-sakura.oss-cn-beijing.aliyuncs.com&#x2F;202410251536836.jpg" title="动漫头像"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>动漫头像</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="皓曦之月" data-src="/images/hutao.png"><p class="name" itemprop="name">皓曦之月</p><div class="description" itemprop="description">比希望更炙热，比黑暗更深邃的，是爱啊！</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">4</span> <span class="name">文章</span></a></div><div class="item tags"><a href="/tags/"><span class="count">2</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/asd1.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/photo1.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/posts/asd1.html" title="测试记录案例">测试记录案例</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/posts/photo1.html" title="动漫头像">动漫头像</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/posts/asd2.html" title="不要停下前进的脚步">不要停下前进的脚步</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/posts/asd.html" title="这个里面是图片哦">这个里面是图片哦</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">皓曦之月 @ Softcute Surname Sakura</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"posts/asd2.html",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/koharu.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html><!-- rebuild by hrmmi -->